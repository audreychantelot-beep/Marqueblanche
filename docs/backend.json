
{
  "entities": {
    "Theme": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Theme",
      "type": "object",
      "description": "Represents a user's theme preference (light or dark).",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the Theme entity."
        },
        "userId": {
          "type": "string",
          "description": "Reference to User. (Relationship: User 1:1 Theme)"
        },
        "themePreference": {
          "type": "string",
          "description": "The user's preferred theme (e.g., 'light', 'dark')."
        }
      },
      "required": [
        "id",
        "userId",
        "themePreference"
      ]
    },
    "User": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "User",
      "type": "object",
      "description": "Represents a user of the application.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the User entity."
        },
        "username": {
          "type": "string",
          "description": "The user's username."
        },
        "email": {
          "type": "string",
          "description": "The user's email address.",
          "format": "email"
        }
      },
      "required": [
        "id",
        "username",
        "email"
      ]
    },
    "SidebarState": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "SidebarState",
      "type": "object",
      "description": "Represents the state of the sidebar (collapsed or expanded) for a user.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the SidebarState entity."
        },
        "userId": {
          "type": "string",
          "description": "Reference to User. (Relationship: User 1:1 SidebarState)"
        },
        "isCollapsed": {
          "type": "boolean",
          "description": "Indicates whether the sidebar is collapsed (true) or expanded (false)."
        }
      },
      "required": [
        "id",
        "userId",
        "isCollapsed"
      ]
    },
    "Link": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Link",
      "type": "object",
      "description": "Represents a link within the application's navigation.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the Link entity."
        },
        "label": {
          "type": "string",
          "description": "The display label for the link."
        },
        "url": {
          "type": "string",
          "description": "The URL the link points to.",
          "format": "uri"
        },
        "icon": {
          "type": "string",
          "description": "The name or identifier of the icon associated with the link."
        }
      },
      "required": [
        "id",
        "label",
        "url",
        "icon"
      ]
    },
    "ColumnPreference": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "ColumnPreference",
      "type": "object",
      "description": "Stores user-specific column visibility preferences for a specific page.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the preference document, typically matching the page identifier."
        },
        "userId": {
          "type": "string",
          "description": "Reference to User. (Relationship: User 1:1 ColumnPreference)"
        },
        "page": {
          "type": "string",
          "description": "The page to which these preferences apply (e.g., 'clients')."
        },
        "columns": {
          "type": "object",
          "description": "A map of column keys to boolean visibility states.",
          "additionalProperties": {
            "type": "boolean"
          }
        },
        "order": {
          "type": "array",
          "description": "An array of column keys representing the display order.",
          "items": {
            "type": "string"
          }
        }
      },
      "required": ["id", "userId", "page", "columns"]
    },
    "Questionnaire": {
      "title": "Questionnaire",
      "type": "object",
      "description": "Represents the responses to the client questionnaire.",
      "properties": {
        "q1": { "type": "string", "description": "Response to question 1" },
        "q2": { "type": "string", "description": "Response to question 2" },
        "q3": { "type": "string", "description": "Response to question 3" },
        "q4": { "type": "string", "description": "Response to question 4 (yes/no)" },
        "q4_software": { "type": "string", "description": "Software for question 4" },
        "q4_method": { "type": "string", "description": "Method for question 4" },
        "q5": { "type": "string", "description": "Response to question 5 (yes/no)" },
        "q5_software": { "type": "string", "description": "Software for question 5" },
        "q5_method": { "type": "string", "description": "Method for question 5" },
        "q6": { "type": "string", "description": "Response to question 6 (yes/no)" },
        "q6_software": { "type": "string", "description": "Software for question 6" },
        "q7": { "type": "string", "description": "Response to question 7 (yes/no)" },
        "q7_software": { "type": "string", "description": "Software for question 7" },
        "q8": { "type": "string", "description": "Response to question 8 (yes/no)" },
        "q8_software": { "type": "string", "description": "Software for question 8" },
        "q9": { "type": "string", "description": "Response to question 9" },
        "q10": { "type": "string", "description": "Response to question 10 (yes/no)" },
        "q10_function": { "type": "string", "description": "Function for question 10" },
        "q11": { "type": "string", "description": "Response to question 11" },
        "q12": { "type": "string", "description": "Response to question 12 (yes/no)" },
        "q12_actions": { "type": "string", "description": "Actions for question 12" },
        "q13": { "type": "string", "description": "Response to question 13 (yes/no)" },
        "q13_project": { "type": "string", "description": "Project for question 13" }
      }
    },
    "Client": {
      "title": "Client",
      "type": "object",
      "properties": {
        "identifiantInterne": { "type": "string" },
        "siren": { "type": "string" },
        "raisonSociale": { "type": "string" },
        "formeJuridique": { "type": "string" },
        "dateDeCloture": { "type": "string", "description": "Date de clôture comptable (JJ/MM)" },
        "contactPrincipal": {
          "type": "object",
          "properties": {
            "nom": { "type": "string" },
            "prenom": { "type": "string" },
            "email": { "type": "string" }
          }
        },
        "avatar": { "type": "string" },
        "missionsActuelles": {
          "type": "object",
          "properties": {
            "collaborateurReferent": { "type": "string" },
            "expertComptable": { "type": "string" },
            "typeMission": { "type": "string" }
          }
        },
        "activites": {
          "type": "object",
          "properties": {
            "codeAPE": { "type": "string" },
            "secteurActivites": { "type": "string" },
            "regimeTVA": { "type": "string" },
            "regimeFiscal": { "type": "string" },
            "typologieClientele": { "type": "string" }
          }
        },
        "obligationsLegales": {
          "type": "object",
          "properties": {
            "assujettiReforme": { "type": "string" },
            "eInvoicing": { "type": "string" },
            "eReportingTransaction": { "type": "string" },
            "eReportingPaiement": { "type": "string" },
            "paEmission": { "type": "string" },
            "paReception": { "type": "string" },
            "niveauObligation": { "type": "string" }
          }
        },
        "outils": {
          "type": "object",
          "properties": {
            "logicielCaisse": { "type": "string" },
            "genereEReporting": { "type": "string" },
            "logicielFacturation": { "type": "string" },
            "conformeFacturationElectronique": { "type": "string" },
            "logicielGestionCommerciale": { "type": "string" },
            "interoperableComptable": { "type": "string" },
            "interoperablePaEmission": { "type": "string" },
            "logicielComptableClient": { "type": "string" },
            "interoperableAutresLogiciels": { "type": "string" },
            "logicielNotesFrais": { "type": "string" }
          }
        },
        "questionnaire": { "$ref": "#/entities/Questionnaire" },
        "maturiteDigitale": { "type": "string", "description": "Client's digital maturity level (Faible, Intermédiaire, Élevée)." },
        "cartographieClient": { "type": "string", "description": "The client's mapping based on digital maturity and legal obligations." },
        "actionsAMener": {
          "type": "array",
          "description": "Actions to be taken for the client.",
          "items": {
            "type": "string"
          }
        },
        "migrationSteps": {
            "type": "object",
            "description": "Suivi des étapes de migration.",
            "properties": {
                "step1": { 
                    "type": "object",
                    "description": "Création du dossier et paramétrage",
                    "properties": {
                        "paramInfoClient": { "type": "boolean" },
                        "paramBanque": { "type": "boolean" }
                    }
                },
                "step2": {
                    "type": "object",
                    "description": "Remontée des données historiques",
                     "properties": {
                        "remonteeFEC": { "type": "boolean" },
                        "remonteeImmobilisations": { "type": "boolean" }
                    }
                },
                "step3": {
                    "type": "object",
                    "description": "Information du client",
                     "properties": {
                        "infoMail": { "type": "boolean" },
                        "presentationOutil": { "type": "boolean" },
                        "mandatPA": { "type": "boolean" }
                    }
                }
            }
        }
      }
    }
  },
  "auth": {
    "providers": [
      "password",
      "anonymous",
      "google.com"
    ]
  },
  "firestore": {
    "structure": [
      {
        "path": "/users/{userId}",
        "definition": {
          "entityName": "User",
          "schema": {
            "$ref": "#/backend/entities/User"
          },
          "description": "Stores core user data. Uses path-based ownership.",
          "params": [
            {
              "name": "userId",
              "description": "The unique identifier of the user."
            }
          ]
        }
      },
      {
        "path": "/users/{userId}/themes/{themeId}",
        "definition": {
          "entityName": "Theme",
          "schema": {
            "$ref": "#/backend/entities/Theme"
          },
          "description": "Stores user-specific theme preferences. Path-based ownership ensures only the user can access their theme.",
          "params": [
            {
              "name": "userId",
              "description": "The unique identifier of the user."
            },
            {
              "name": "themeId",
              "description": "The unique identifier of the theme document."
            }
          ]
        }
      },
      {
        "path": "/users/{userId}/sidebarState/{sidebarStateId}",
        "definition": {
          "entityName": "SidebarState",
          "schema": {
            "$ref": "#/backend/entities/SidebarState"
          },
          "description": "Stores the user's sidebar state. Path-based ownership applies here as well.",
          "params": [
            {
              "name": "userId",
              "description": "The unique identifier of the user."
            },
            {
              "name": "sidebarStateId",
              "description": "The unique identifier of the sidebar state document."
            }
          ]
        }
      },
      {
        "path": "/users/{userId}/columnPreferences/{preferenceId}",
        "definition": {
          "entityName": "ColumnPreference",
          "schema": {
            "$ref": "#/backend/entities/ColumnPreference"
          },
          "description": "Stores user-specific column visibility preferences. Path-based ownership applies.",
          "params": [
            {
              "name": "userId",
              "description": "The unique identifier of the user."
            },
            {
              "name": "preferenceId",
              "description": "A unique ID for the preference set, often matching the page name."
            }
          ]
        }
      },
      {
        "path": "/users/{userId}/clients/{clientId}",
        "definition": {
          "entityName": "Client",
          "schema": {
            "$ref": "#/entities/Client"
          },
          "description": "Stores client data for a specific user.",
          "params": [
            { "name": "userId", "description": "The user's ID." },
            { "name": "clientId", "description": "The client's ID." }
          ]
        }
      },
      {
        "path": "/links/{linkId}",
        "definition": {
          "entityName": "Link",
          "schema": {
            "$ref": "#/backend/entities/Link"
          },
          "description": "Stores application links, which can be read by all users but only managed by admins (if any).",
          "params": [
            {
              "name": "linkId",
              "description": "The unique identifier of the link."
            }
          ]
        }
      }
    ],
    "reasoning": "The Firestore data structure is designed to ensure authorization independence and support secure list operations (QAPs). It leverages path-based ownership for user-specific data like themes and sidebar states. Each user's data is stored under their unique ID, providing a clear ownership structure. This eliminates the need for `get()` calls in security rules, enabling atomic operations.\n\nSpecifically:\n\n*   **/users/{userId}**: Stores core user data.\n*   **/users/{userId}/themes/{themeId}**: Stores user-specific theme preferences. Path-based ownership ensures only the user can access their theme.\n*   **/users/{userId}/sidebarState/{sidebarStateId}**: Stores the user's sidebar state. Path-based ownership applies here as well.\n*   **/users/{userId}/columnPreferences/{preferenceId}**: Stores user-specific column visibility preferences.\n*   **/users/{userId}/clients/{clientId}**: Stores client data specific to a user.\n\nThe chosen structure prioritizes simplicity, security, and scalability, aligning with the core design principles of authorization independence, clarity of intent, and DBAC (Database-Based Access Control). QAPs are supported via structural segregation, preventing listing of data outside the scope of ownership defined by path-based rules."
  }
}

    